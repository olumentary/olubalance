<%= form_for([@transaction.account, @transaction], html: { data: { controller: "category-suggest", category_suggest_url_value: suggest_category_account_transactions_path(@transaction.account) } }) do |f| %>
  <% if @transaction.errors.any? %>
    <article id="error_explanation" class="message is-danger">
      <div class="message-header">
        Something went wrong!
      </div>
      <div class="message-body content">
        Please correct the following <span class="has-text-weight-bold"><%= pluralize(@transaction.errors.count, "error") %></span>:
        <ul>
          <% @transaction.errors.full_messages.each do |msg| %>
            <li><%= msg %></li>
          <% end %>
        </ul>
      </div>
    </article>
  <% end %>

  <div class="columns">
    <!-- Fields -->
    <div class="column">
      <!-- Account Selection -->
      <div class="field">
        <label class="label has-text-grey">Account</label>
        <div class="control has-icons-left">
          <div class="select is-fullwidth is-primary">
            <%= f.select :account_id,
                        @user_accounts.map { |a| [a.name, a.id] },
                        { selected: @transaction.account_id },
                        { data: { action: "change->trxform#accountChanged" } } %>
          </div>
          <div class="icon is-small is-left has-text-primary">
            <i class="fas fa-piggy-bank"></i>
          </div>
        </div>
        <% unless @transaction.new_record? %>
          <p class="help has-text-grey is-size-7 mt-2">
            ðŸ’¡ Changing the account will update balances for both accounts automatically
          </p>
        <% end %>
      </div>

      <!-- Transaction Type -->
      <div class="field">
        <%= f.label :trx_type, class: "label has-text-grey" do %>Transaction Type<% end %>

        <div class="control" data-controller="trxtype-radio-buttons">
          <div class="buttons are-small">
            <button
              type="button"
              class="button is-success is-outlined"
              data-trxtype-radio-buttons-target="button"
              data-value="credit"
              id="creditType"
            >
              Credit
            </button>
            <button
              type="button"
              class="button is-danger is-outlined"
              data-trxtype-radio-buttons-target="button"
              data-value="debit"
              id="debitType"
            >
              Debit
            </button>
          </div>

          <%= f.hidden_field :trx_type, 
                value: @transaction.trx_type_value_form,
                data: { trxtype_radio_buttons_target: "input" }
          %>
        </div>
      </div>

      <!-- Transaction Type -->
      <div class="field">
        <label class="label has-text-grey">Date</label>
        <div class="control">
          <%= f.date_field :trx_date, class: "input is-primary", type: "date", value: @transaction.trx_date_form_value %>
        </div>
      </div>

      <!-- Description -->
      <div class="field">
        <label class="label has-text-grey">Description</label>
        <div class="control has-icons-left" data-controller="typeahead" data-typeahead-url-value="<%= descriptions_account_transactions_path %>" style="position: relative;">
          <%= f.text_field :description, class: "input is-primary",
                                        placeholder: "Description",
                                        data: { 
                                          typeahead_target: "input",
                                          category_suggest_target: "input",
                                          action: "input->typeahead#search blur->typeahead#hideSuggestions blur->category-suggest#suggest"
                                        } %>
          <span class="icon is-small is-left has-text-primary">
            <i class="fas fa-file-alt"></i>
          </span>
          <div class="dropdown-menu is-hidden" data-typeahead-target="suggestions" style="position: absolute; top: 100%; left: 0; right: 0; z-index: 100;">
            <div class="dropdown-content" style="max-height: 200px; overflow-y: auto;" data-typeahead-target="content"></div>
          </div>
        </div>
      </div>

      <%= render "categories/select", categories: @categories, selected: @transaction.category_id, suggestion: @category_suggestion %>

      <!-- Amount -->
      <div class="field">
        <label class="label has-text-grey">Amount</label>
        <div class="control has-icons-left">
          <%= f.text_field :amount, class: "input is-primary",
                                    placeholder: "5.00",
                                    value: @transaction.amount_form %>
          <span class="icon is-small is-left has-text-primary">
            <i class="fas fa-dollar-sign"></i>
          </span>
        </div>
      </div>

      <!-- Memo -->
      <div class="field">
        <label class="label has-text-grey">Memo</label>
        <div class="control has-icons-left">
          <%= f.text_field :memo, class: "input is-primary",
                                  placeholder: "Memo" %>
          <span class="icon is-small is-left has-text-primary">
            <i class="fas fa-info-circle"></i>
          </span>
        </div>
      </div>

      <!-- Attachments -->
      <label class="label has-text-grey">Receipts</label>
      <div class="file">
        <label class="file-label">
          <%= f.file_field :attachments, multiple: true, class: "file-input is-primary", data: { action: 'change->trxform#attachmentSelected', 'trxform-target': 'attachment' } %>
          <span class="file-cta has-background-primary">
            <span class="file-icon has-text-white">
              <i class="fas fa-upload"></i>
            </span>
            <span class="file-label has-text-white">
              <%= @transaction.add_receipt_button_label %>
            </span>
          </span>
        </label>
      </div>
      
      <p class="help has-text-grey is-size-7 mt-2">
        <%= @transaction.attachment_upload_help_text %>
      </p>
      
      <div class="ob-file-name has-text-grey">
        <span data-trxform-target="newreceipt" class="has-text-weight-bold has-text-danger"></span>
        <span data-trxform-target="filename"><%= @transaction.filename_form %></span>
      </div>
      
      <!-- Display existing attachments -->
      <% if @transaction.attachments.attached? %>
        <div class="mt-3">
          <p class="has-text-grey is-size-7">Current attachments:</p>
          <div class="tags">
            <% @transaction.attachments.each_with_index do |attachment, index| %>
              <span class="tag is-info is-light" id="attachment-<%= attachment.id %>" style="margin-bottom: 0.5rem;">
                <span class="icon is-small">
                  <i class="fas fa-paperclip"></i>
                </span>
                <span style="max-width: 200px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;" title="<%= attachment.filename %>">
                  <%= attachment.filename %>
                </span>
                <button 
                  type="button" 
                  class="delete is-small" 
                  style="margin-left: 0.5rem;"
                  data-action="click->trxform#deleteAttachment"
                  data-attachment-id="<%= attachment.id %>"
                  data-transaction-id="<%= @transaction.id %>"
                  data-account-id="<%= @transaction.account_id %>"
                  title="Delete attachment"
                ></button>
              </span>
            <% end %>
          </div>
        </div>
      <% end %>
    </div>
  </div> <!-- /columns -->

  <div class="field is-grouped">
    <div class="control">
      <%= link_to "Cancel", account_transactions_path, class: "button is-link is-outlined has-background-white" %>
    </div>
    <div class="control">
      <%= f.button @transaction.button_label,
          type: 'submit',
          class: "button is-link",
          data: {
            action: 'click->trxform#create',
            'trxform-target': 'submit'
          }
      %>
    </div>
  </div>
<% end %>

<!-- Account Transfer Confirmation Modal -->
<% unless @transaction.new_record? %>
  <div 
    id="account-transfer-modal-<%= @transaction.id %>" 
    class="modal"
    style="z-index: 9999" 
    data-shared-target="modal"
  >
    <div 
      class="modal-background"
      onclick="window.cancelAccountTransfer()"
    ></div>
    <div class="modal-content ob-modal-card">
      <div class="card">
        <header class="card-header has-background-danger">
          <p class="card-header-title has-text-white">
            <span class="icon">
              <i class="fas fa-exchange-alt"></i>
            </span>
            <span>Move Transaction</span>
          </p>
          <button 
            class="delete" 
            aria-label="close"
            onclick="window.cancelAccountTransfer()"
            style="margin: 0.75rem;"
          ></button>
        </header>
        <section class="card-content">
          <div class="content">
                      <p class="mb-4">
            Are you sure you want to move this transaction to <strong><span id="transfer-account-name"></span></strong>?
          </p>
          <div class="notification is-light mb-4">
            <p class="has-text-weight-semibold mb-2">Transaction Details:</p>
            <ul>
              <li><strong>Date:</strong> <span id="transfer-transaction-date"></span></li>
              <li><strong>Description:</strong> <span id="transfer-transaction-description"></span></li>
              <li><strong>Amount:</strong> <span id="transfer-transaction-amount"></span></li>
            </ul>
          </div>
            <div class="notification is-info is-light">
              <p class="has-text-weight-semibold">This will update the balances for both accounts:</p>
              <ul class="mt-2">
                <li>Remove the transaction amount from the current account</li>
                <li>Add the transaction amount to the new account</li>
              </ul>
            </div>
          </div>
        </section>
        <footer class="card-footer">
          <button 
            class="card-footer-item has-text-weight-bold has-text-grey"
            onclick="window.cancelAccountTransfer()"
          >
            Cancel
          </button>
          <button 
            class="card-footer-item has-text-weight-bold has-text-danger"
            onclick="window.confirmAccountTransfer()"
          >
            Move Transaction
          </button>
        </footer>
      </div>
    </div>
  </div>
<% end %>